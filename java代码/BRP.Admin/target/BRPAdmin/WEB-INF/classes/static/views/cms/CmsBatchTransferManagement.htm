<!DOCTYPE html>
<html>
<head>
<title>批量转移</title>

<meta http-equiv="keywords" content="keyword1,keyword2,keyword3">
<meta http-equiv="description" content="this is my page">
<meta http-equiv="content-type" content="text/html; charset=UTF-8">

<link rel="stylesheet" type="text/css" href="../../themes/custom/easyui.css" />
<link rel="stylesheet" type="text/css" href="../../themes/icon.css" />
<script type="text/javascript" src="../../js/jquery.js"></script>
<script type="text/javascript" src="../../js/common.js"></script>
<script type="text/javascript" src="../../js/config.js"></script>
<script type="text/javascript" src="../../js/json2.js"></script>
<script type="text/javascript" src="../../js/jquery.easyui.min.js"></script>
<script type="text/javascript" src="../../js/util.js?v=1"></script>
<script type="text/javascript" src="../../js/easyui-lang-zh_CN.js"></script>
<script type="text/javascript" src="../../js/jquery.cookie.js"></script>
<script type="text/javascript" src="../../js/jquery.query.js"></script>
<link rel="stylesheet" href="../../css/common.css?v=2" type="text/css"></link>
<link rel="stylesheet" href="../../css/base.css" type="text/css"></link>
<script type="text/javascript" src="../../js/management.js"></script>
<script type="text/javascript" src="../../js/cms/cms.promission.js"></script>

<script type="text/javascript">
	managementContext.dataName="CmsChannel";
	managementContext.tableName="cms_Channel";
	managementContext.primaryKeyName="id";
	managementContext.allowPaging = false;
	managementContext.managementPermission = "CmsBatchTransferManagement";
	
	$(function(){
		var permissions = JSON.parse(localStorage.permissions);
		var tableGridPermissions = $("#dlg-buttons [id^='btn']");
		for(var i=0;i<tableGridPermissions.length;i++){
			var id=tableGridPermissions[i].id;
			var permission = managementContext.managementPermission+id.split("_")[0].substr(3);
			if(!checkIsFunctionPermission(permissions,permission)){
				$("#"+id).hide();
			}
		}
		//站点、栏目联动
		$("#cmbCmsSiteId").combobox({
			onChange: function (n,o) {
				var cmsSiteId = $(this).val();
				if(cmsSiteId != ""){
  					bindComboTreeBySite(cmsSiteId);
				}
			}

		});
		//默认选中转移后不删除
		$("#divIsDelete input[value=0]").trigger("click");
		
	});
	function bindControls(){
		//绑定栏目树形列表
		bindCmsChannelIdNameTreeWidthValue(function(node) {
			bindData();
		});
		//绑定站点列表
		bindIdNameComboBoxWithValue("cmbCmsSiteId","cms_site","",getCookie("cmsSiteId"));
		//绑定转移类型
		bindCodeNameComboBoxWithValue("cmbCmsContentTransferCode","cms_content_transfer_type","","All");	
	}
	function bindData(){
	}
	//绑定栏目树形列表
	function bindCmsChannelIdNameTreeWidthValue(clickCallback) {
		var requestParameters = getParameters();
		var cmsSiteId = $.cookie("cmsSiteId");
		requestParameters.operatorId = $.cookie("sysUserId");
		requestParameters.cmsSiteId = cmsSiteId;
		requestParameters.cmsLanguageCode = currentCmsLanguageCode;
		requestParameters.condition = "cms_site_id='" + cmsSiteId + "'";
		call("GetCmsChannelList", requestParameters, function(result) {
			outputCmsChannelTree("ulCmsChannel", result.data.dataList, "id", "name",
					"parentId", "选择栏目", "0", "checkbox", clickCallback);
			var cmsChannelTreeButton = $("#ulCmsChannel .tree-hit");
			for(var i=0;i<cmsChannelTreeButton.length;i++){
				if(i>0){
					cmsChannelTreeButton.eq(i).trigger("click");
				}
			}
		});
	}
	/*
	 * 输出树
	 */
	function outputCmsChannelTree(controlId, lstData, valueFieldName, textFieldName,
			parentFieldName, rootText, rootValue, checkbox, clickCallback) {
	
		var childrenTreeData = getTreeData(lstData, rootValue, valueFieldName,
				textFieldName, parentFieldName);
	
		var treeData = new Array();
		var rootNode = new Object();
		rootNode.id = rootValue;
		rootNode.text = rootText;
		rootNode.children = childrenTreeData;
		treeData.push(rootNode);
		var treeOptions = {
			checkbox : checkbox,
			cascadeCheck : false,
			data : treeData,
			lines : true,
			
		};
		// alert(JSON.stringify(treeOptions));
		$("#" + controlId).tree(treeOptions);
	}
	/*
	 * 绑定联动查询树型表
	 */
	function bindComboTreeBySite(cmsSiteId) {
		var condition = "cms_site_id=" + cmsSiteId;
		bindCmsComboTreeWidthPermission("cmbCmsChannelId", "GetCmsChannelList", 0, "id", "name", "parentId",null, condition);
	}
	/*
	 * 绑定联动查询树型表
	 */
	 function getCmsChannelUl(){
	 }
	/*
	 * 转移
		1、将栏目修改成指定栏目
		2、三种转移类型
			①转移栏目 仅修改栏目的cms_site_id与parent_id
			②转移栏目中的内容 修改内容中的cms_channel_id
			③转移栏目及其中的内容 两张表都要修改
		3、转移后是否删除
			是:
	 */
	function transfer() {
		var data = getEntity();
		data.oldChannelId = getTreeCheckedValues("ulCmsChannel", "id");
		data.dataName=managementContext.dataName;
		if(!isPermitted(data.cmsChannelId)){
			alert();
		}else{
	 		 call("Transfer", data, function(result) {
				
				bindControls();
	
			});
		}

	}
	/*
	 * 取得实体
	 */
	function getEntity() {
		var newEntity = getEntityBase();
		var deleteFlag =$("#divIsDelete :checked").val();
		newEntity.deleteFlag = deleteFlag;
		return newEntity;
	}
	/*
	 * 绑定组合框
	 */
	function bindComboBoxWithValue(controlId, tableName, valueFieldName,
			textFieldName, orderBy, emptyText, condition, value) {
		$("#" + controlId).combobox("clear");
		var data = new Object();
		data.tableName = tableName;
		data.orderBy = orderBy;
		data.condition = condition;
		call("GetTable", data, function(result) {
			// console.log(result.data);
			var comboboxData = result.data;
			$("#" + controlId).combobox({
				valueField : valueFieldName,
				textField : textFieldName,
				data : comboboxData
			});
			$("#" + controlId).combobox("setValue", value);
		});
	}

</script>
	<div id="divDetailDialog" class="easyui-layout" style="width:100%;overflow:auto;"
	 closed="false" fit="true">
			<div buttons="#dlg-buttons">
				<form id="formDetail" method="post" novalidate
					style="margin:0;padding:20px 50px">
					<span>将栏目:</span>
					<div style="margin-bottom:10px;width: 20%;height:530px;border: 1px solid Gray;overflow:auto;">
						<ul id="ulCmsChannel" class="easyui-tree">
						</ul>
					</div>
					<div style="margin-bottom:10px">
						<span style="display: block;margin-bottom: 10px;">转移到:</span>
						<input id="cmbCmsSiteId" name="cmbCmsSiteId"
							class="easyui-combobox" label="站点:"
							labelPosition="left" style="width:30%">
						<input id="cmbCmsChannelId" name="cmbCmsChannelId"
							class="easyui-combotree" label="目标栏目"
							labelPosition="left" style="width:30%"/>
					</div>
					<div style="margin-bottom:10px">
						<input id="cmbCmsContentTransferCode" name="cmbCmsContentTransferCode"
							class="easyui-combobox" label="转移类型:"
							labelPosition="left" style="width:30%">
						
					</div>
					<div style="margin-bottom:10px" id="divIsDelete">
						<span style="display: block;margin-bottom: 10px;">转移后是否删除:</span>
					
						<input id="isDelete" class="isDelete" name="tj" value="1" type="radio">是
						<input id="isDelete" class="isDelete" name="tj" value="0" type="radio">否
						
					</div>
				</form>
			</div>
			<div id="dlg-buttons" style="text-align:center;"  >
				<a href="javascript:void(0)" class="easyui-linkbutton c6"
					iconCls="icon-ok" onclick="transfer()" style="width:90px" id="btnTransfer">转移</a>
			</div>
			
		</div>

</body>
</html>