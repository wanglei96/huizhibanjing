<!DOCTYPE html>
<html>
<head>
<title>角色管理</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<link rel="stylesheet" type="text/css"
	href="../../themes/custom/easyui.css"></link>
<link rel="stylesheet" type="text/css" href="../../themes/icon.css"></link>
<script type="text/javascript" src="../../js/jquery.js"></script>
<script type="text/javascript" src="../../js/common.js"></script>
<script type="text/javascript" src="../../js/config.js"></script>
<script type="text/javascript" src="../../js/json2.js"></script>
<script type="text/javascript" src="../../js/jquery.easyui.min.js"></script>
<script type="text/javascript" src="../../js/util.js"></script>
<script type="text/javascript" src="../../js/easyui-lang-zh_CN.js"></script>
<script type="text/javascript" src="../../js/jquery.query.js"></script>
<script type="text/javascript" src="../../js/jquery.cookie.js"></script>
<script type="text/javascript" src="../../js/cms/cms.promission.js"></script>
<script type="text/javascript" src="../../js/management.js"></script>

<link rel="stylesheet" href="../../css/common.css" type="text/css"></link>
<link rel="stylesheet" href="../../css/base.css" type="text/css"></link>
<script>
	managementContext.dataName = "SysRole";
	managementContext.tableName = "sys_role";
	managementContext.managementPermission = "CmsPermissionManagement";
	var permissionCache = new Object();
	permissionCache.values = new Object();
	var isUpdatePermissionCache = false;

	managementContext.operationColumnWidth = 150;
	managementContext.customTableColumns = [ {
		field : 'name',
		title : '名称',
		fixed : true,
		width : 150,
		align : 'left'
	}, {
		field : 'description',
		title : '描述',
		width : 100,
		align : 'left'
	} ];

	function bindControls() {
		bindIdNameTree("ulCmsSiteId", "cms_site", "选择站点",false, function(node) {
					bindCmsChannelData(node.id);
				});
	}
	
	function bindCmsChannelData(nodeId){
		var cmsSiteNodeId = null;
		try{
			cmsSiteNodeId = $("#ulCmsSiteId").tree("getSelected").id;
		}catch(e){
			
		}
		if(cmsSiteNodeId == null){
			cmsSiteId = nodeId;
		}else{
			cmsSiteId = cmsSiteNodeId;
		}
		if(cmsSiteId != 0){
			permissionCache.cmsSiteId = cmsSiteId;
			bindCmsTree("ulCmsChannelMenu","cms_channel",cmsSiteId, "id", "name",
			"parent_id", "栏目列表", 0, "display_order", true, function() {
			});
		}
	}
	/*
	 * 绑定CMS树
	 */
	function bindCmsTree(controlId, tableName,cmsSiteId,valueFieldName, textFieldName,
			parentFieldName, rootText, rootValue, orderBy, checkbox, clickCallback) {
		var data = new Object();
		data.orderBy = orderBy;
		data.tableName = tableName;
		data.condition = "cms_site_id ="+cmsSiteId;
		call("GetTable", data, function(result) {
			// alert(JSON.stringify(result));
			isUpdatePermissionCache = false;
			outputTree(controlId, result.data, valueFieldName, textFieldName,
					parentFieldName, rootText, rootValue, checkbox, clickCallback);
			showCmsChannelMenu(cmsSiteId);
			$("#ulCmsChannelMenu").tree("expandAll");
			isUpdatePermissionCache = true;
		});
	}
	/*
	取得操作按钮列表
	 */
	function getOperationButtonHtmlArray(dataItem) {
		var lnkCmsChannelMenuHtml = getGridCmsChannelMenuButtonHtml(dataItem);
		return lnkCmsChannelMenuHtml;
	}
	/*
	 * 打开栏目权限 
	 */
	function openCmsChannelMenuDialog(primaryKey,name) {
		//清空权限缓存
		permissionCache.values =  new Object();
		//获取id放到隐藏域中
		$('#hfSysRoleId').attr("value", primaryKey);
		//打开Dialog
		uncheckTree("ulCmsSiteId");
		var sysRoleId = $('#hfSysRoleId').val();
		permissionCache.sysRoleId = sysRoleId;
		var data = new Object();
		data.tableName = "sys_role_permission";
		data.sysRoleId = sysRoleId;
		data.cmsSiteId = $.cookie("cmsSiteId");
		call("GetSysRoleCmsChannelPermissionListBySysUserId", data, function(result) {
			setPermissionList(result.data);
			//显示当前选择的站点的权限信息
			var cmsSiteNode = $("#ulCmsSiteId").tree('getSelected');
			if(null != cmsSiteNode){
				bindCmsChannelData(cmsSiteNode.id);
			}
		});
		//bindCmsChannelData($.cookie("cmsSiteId"));
		$('#divChannelMenuDialog').dialog('open').dialog('center').dialog('setTitle',
				'栏目权限:'+name);
		//event.stopPropagation();
	}
	
	/*
	 * 取得选中的树节点
	 */
	function getTreeCheckedValues(controlId, propertyName) {
		var nodes = $('#' + controlId).tree('getChecked',  "checked");
		if (nodes == null) {
			return null;
		}
		// alert(JSON.stringify(nodes));
		var checkedValues = [];
		for (i = 0; i < nodes.length; i++) {
			if (nodes[i].attributes != null) {
				checkedValues.push(nodes[i].attributes[propertyName]);
			}
		}
		return checkedValues;
	}
	
	function setPermissionList(data){
		var cmsSiteList = $("#ulCmsSiteId").tree("getChildren",$("#ulCmsSiteId").tree("getRoot"));
		for(var i=0;i<cmsSiteList.length;i++){
				var permissions = [];
				var siteId = cmsSiteList[i].id;
				for(var j=0;j<data.length;j++){
					if(siteId == data[j].cmsSiteId){
						permissions.push(data[j].cmsChannelId);
					}
				}
			permissionCache.values[siteId] = permissions;
		}
	}
	function showCmsChannelMenu(cmsSiteId){
		var cmsChannelList = permissionCache.values[(cmsSiteId)];
		var treeData = [];
		for(var i=0;i<cmsChannelList.length;i++){
			var treeDataItem = new Object();
			treeDataItem.cmsChannelId = cmsChannelList[i];
			treeData.push(treeDataItem);
		}
		checkTree("ulCmsChannelMenu",treeData, "cmsChannelId", "id");
	}
	/*
	 * 取得设置栏目权限Html
	 */
	function getGridCmsChannelMenuButtonHtml(dataItem) {
		var primaryKey = getPrimaryKey(dataItem);
		var buttonId = "btnSetPermission_"+primaryKey;
		return "<a id='"+buttonId+"' class='easyui-linkbutton grid_button' href='#' onclick=\"return openCmsChannelMenuDialog('"
				+ primaryKey + "','"+dataItem.name+"')\">设置栏目权限</a>";
	}
	/*
	 * 关闭栏目Dialog对话框
	 */
	function closeCmsChannelMenuDialog() {
		$('#divChannelMenuDialog').dialog('close');
	}
	/*
	 * 保存栏目权限
	 */
	function saveCmsChannelMenu() {
		var data = permissionCache;
		call("AddCmsChannelPermission", data, function(result) {
			closeCmsChannelMenuDialog();
		});
	}
	/*
	 *取得栏目权限设置选中数据
	 */
	function getEntityCmsChannelSysRolePermission() {
		//获取角色id
		var id = $('#hfSysRoleId').val();
		//alert(id);
		//选中的菜单信息
		var values = getTreeCheckedValues("ulCmsChannelMenu", "id");
		//alert(values);
		var newSysRolePermission = new Object();
		newSysRolePermission.sysRoleId = id;
		newSysRolePermission.values = values;
		return newSysRolePermission;
	}
	/*
	 * 输出树
	 */
	function outputTree(controlId, lstData, valueFieldName, textFieldName,
			parentFieldName, rootText, rootValue, checkbox, clickCallback) {
	
		var childrenTreeData = getTreeData(lstData, rootValue, valueFieldName,
				textFieldName, parentFieldName);
	
		var treeData = new Array();
		var rootNode = new Object();
		rootNode.id = rootValue;
		rootNode.text = rootText;
		rootNode.children = childrenTreeData;
		treeData.push(rootNode);
		var treeOptions = {
			checkbox : checkbox,
			data : treeData,
			onClick : function(node) {
				if (clickCallback != null) {
					clickCallback(node);
				}
			},
			onCheck : function(){
				savePermissionList();
			}
		};
		$("#" + controlId).tree(treeOptions);
	}
	function savePermissionList(){
		if(isUpdatePermissionCache){
			var permissionData = getEntityCmsChannelSysRolePermission();
			var sysRoleId = permissionData.sysRoleId;
			var cmsChannelList = permissionData.values;
			var permissions = [];
			for(var i=0;i<cmsChannelList.length;i++){
				permissions.push(cmsChannelList[i]);
			}
			permissionCache.values[cmsSiteId] = permissions;
		}
	}
</script>
</head>

<body>
	<!-- 存放sysRoleId -->
	<input type="hidden" id="hfSysRoleId" value="" />
	<div class="easyui-layout" style="width:100%;" fit="true">
		<div class="toolbar_panel" id="divToolbar">
			<a href="#" class="easyui-linkbutton" iconCls="icon-add" plain="true"
				onclick="openAddDialog()" id="btnAdd">新增</a> <a href="#"
				class="easyui-linkbutton" iconCls="icon-remove" plain="true"
				onclick="deleteDataItems()" id="btnBatchDelete">删除</a><a id="lnkRefreshPage" href="#"
				class="easyui-linkbutton" iconCls="icon-reload" plain="true"
				onclick="refreshPage()">刷新</a>
		</div>
		<table id="tableGrid">
		</table>
		<div>
			<div id="divDetailDialog" class="easyui-dialog" style="width:400px"
				closed="true" buttons="#dlg-buttons">
				<input type="hidden" id="hid" value="" />
				<form id="formDetail" method="post" novalidate
					style="margin:0;padding:20px 50px">

					<div style="margin-bottom:10px">
						<input id="txtName" name="txtName" class="easyui-textbox"
							label="名称:" style="width:100%">
					</div>
					<div style="margin-bottom:10px">
						<input id="txtDescription" name="txtDescription"
							class="easyui-textbox" label="描述:" multiline="true"
							labelPosition="left" style="width:100%;height:120px;">
					</div>
				</form>
			</div>
			<div id="dlg-buttons">
				<a href="javascript:void(0)" class="easyui-linkbutton c6"
					iconCls="icon-ok" onclick="save()" style="width:90px" id="btnSave">保存</a>
				<a href="javascript:void(0)" class="easyui-linkbutton"
					iconCls="icon-cancel" onclick="javascript:closeDetailDialog();">取消</a>
			</div>
		</div>
		<div>
			<!-- 栏目权限 -->
			<div id="divChannelMenuDialog" class="easyui-dialog"
				style="width:500px;height:450px;" closed="true"
				buttons="#dlg-menu-buttons" resizable="true">
				<div id="divCmsSite" style="float:left">
					<ul id="ulCmsSiteId"></ul>
				</div>
				<div id="divCmsChannel" style="float:left;height:375px;width:382px;overflow: auto">
					<form id="formCmsChannelDetail" method="post" novalidate
						style="margin:0;padding-left:50px">
						<ul id="ulCmsChannelMenu" class="easyui-tree">
						</ul>
					</form>
				</div>
			</div>
			<div id="dlg-menu-buttons">
				<a href="javascript:void(0)" class="easyui-linkbutton"
					iconCls="icon-ok" onclick="saveCmsChannelMenu()" id="btnsaveChannelMenu">保存</a> <a
					href="javascript:void(0)" class="easyui-linkbutton"
					iconCls="icon-cancel" onclick="javascript:closeCmsChannelMenuDialog();">取消</a>
			</div>
		</div>
	</div>
</body>
</html>