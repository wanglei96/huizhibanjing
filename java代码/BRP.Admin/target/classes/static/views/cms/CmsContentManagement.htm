<!DOCTYPE html>
<html>
<head>
<title>参数管理</title>

<meta http-equiv="keywords" content="keyword1,keyword2,keyword3">
<meta http-equiv="description" content="this is my page">
<meta http-equiv="content-type" content="text/html; charset=UTF-8">

<!--<link rel="stylesheet" type="text/css" href="./styles.css">-->
<link rel="stylesheet" type="text/css"
	href="../../themes/custom/easyui.css"></link>
<link rel="stylesheet" type="text/css" href="../../themes/icon.css"></link>
<script type="text/javascript" src="../../js/jquery.js"></script>
<script type="text/javascript" src="../../js/common.js"></script>
<script type="text/javascript" src="../../js/config.js"></script>
<script type="text/javascript" src="../../js/json2.js"></script>
<script type="text/javascript" src="../../js/jquery.easyui.min.js"></script>
<script type="text/javascript" src="../../js/util.js"></script>
<script type="text/javascript" src="../../js/easyui-lang-zh_CN.js"></script>
<script type="text/javascript" src="../../js/jquery.query.js"></script>
<script type="text/javascript" src="../../js/jquery.cookie.js"></script>
<script type="text/javascript" src="../../js/management.js"></script>
<link rel="stylesheet" href="../../css/common.css" type="text/css"></link>
<link rel="stylesheet" href="../../css/base.css" type="text/css"></link>
<script type="text/javascript" src="../../js/cms/cms.promission.js"></script>
<link rel="stylesheet" href="../../css/CmsChannelDetial.css"></link>
<script>
	managementContext.dataName = "CmsContent";
	managementContext.tableName = "cms_content";
	managementContext.primaryKeyName = "id";
	managementContext.detailPageMode = "Page";
	managementContext.operationColumnWidth = 200;

	managementContext.customTableColumns = [ {
		field : 'title',
		title : '内容标题',
		fixed : true,
		width : 320,
		align : 'left'
	}, {
		field : 'sub_title',
		title : '副标题',
		fixed : true,
		width : 320,
		align : 'left'
	},{
		field : 'url',
		title : '外部链接',
		fixed : true,
		width : 280,
		align : 'center'
	}, {
		field : 'cms_content_status_name',
		title : '状态',
		fixed : true,
		width : 100,
		align : 'center'
	}];
	function bindControls() {
		//绑定参数分类
		bindCmsTreeWidthPermission("ulCmsChannelTree", "GetCmsChannelList","id","name","parentId",
				"栏目列表",0,"", false, function(node) {
					bindData();
				});
	}
	/*
	 * 绑定数据
	 */
	function bindData() {
		var requestParameters = getParameters();
		requestParameters.cmsLanguageCode = currentCmsLanguageCode;
		requestParameters.cmsSiteId =  $.cookie("cmsSiteId");
		if(requestParameters.cmsChannelId != "" && requestParameters.cmsChannelId != 0){
			call("GetCmsContentListWidthPermission", requestParameters, function(
				result) {
			outputData(result.data.dataList);
			//设置功能权限
			bindTableGridFunctionPermission();
			// 设置分页
			if (managementContext.allowPaging) {
				setPager(result.data);
			}
		});
		} 
	} 
	/*
	 * 取得操作按钮列表，默认为查看，修改，删除三个按钮
	 */
	function getOperationButtonHtmlArrayBase(dataItem) {
		var arrOpeartionButtonHtml = new Array();
		var lnkViewHtml = getGridViewButtonHtml(dataItem);
		var lnkEditHtml = getGridEditButtonHtml(dataItem);
		var lnkDeleteHtml = getGridDeleteButtonHtml(dataItem);
		var moveUpHtml = getGridMoveUpButtonHtml(dataItem);
		var moveDownHtml = getGridMoveDownButtonHtml(dataItem);
		arrOpeartionButtonHtml.push(lnkViewHtml);
		arrOpeartionButtonHtml.push(lnkEditHtml);
		arrOpeartionButtonHtml.push(lnkDeleteHtml);
		arrOpeartionButtonHtml.push(moveUpHtml);
		arrOpeartionButtonHtml.push(moveDownHtml);
		return arrOpeartionButtonHtml;
	}
	/*
	 * 取得上移按钮Html
	 */
	function getGridMoveUpButtonHtml(dataItem) {
		var primaryKey = getPrimaryKey(dataItem);
		var buttonId = "btnMove_Up"+primaryKey;
		return "<a id='"+buttonId+"' class='easyui-linkbutton grid_button' href='#' onclick=\"return moveDown('"
				+ primaryKey + "','" + dataItem.cms_channel_id + "')\">上移</a>";
	}
	
	/*
	 * 取得下移按钮Html
	 */
	function getGridMoveDownButtonHtml(dataItem) {
		var primaryKey = getPrimaryKey(dataItem);
		var buttonId = "btnMove_Down"+primaryKey;
		return "<a id='"+buttonId+"' class='easyui-linkbutton grid_button' href='#' onclick=\"return moveUp('"
				+ primaryKey + "','" + dataItem.cms_channel_id + "')\">下移</a>";
	}
	
	/*
	 * 绑定树
	 */
	function bindTree(controlId, tableName, valueFieldName, textFieldName,
			parentFieldName, rootText, rootValue, orderBy, checkbox, clickCallback) {
		var data = new Object();
		var cmsSiteId = $.cookie("cmsSiteId");
		data.orderBy = orderBy;
		data.tableName = tableName;
		data.condition = "cms_site_id='" + cmsSiteId + "'";
		call("GetTable", data, function(result) {
			// alert(JSON.stringify(result));
			//console.log(result);
			outputTree(controlId, result.data, valueFieldName, textFieldName,
					parentFieldName, rootText, rootValue, checkbox, clickCallback);
		});
	}
	/*
	  取得请求参数
	 */
	function getParameters() {
		var parameters = getParametersBase();
		var cmsChannelId = getCmsChannelId();
		var cmsSiteId = $.cookie("cmsSiteId");
		parameters.cmsChannelId = cmsChannelId;
		parameters.operatorId = $.cookie("sysUserId");
		parameters.condition = "cms_site_id='" + cmsSiteId + "'";
		parameters.orderBy = "display_order desc";
		if(cmsChannelId != ""){
			parameters.condition += "and cms_channel_id='" + cmsChannelId + "'";
		}
		return parameters;
	}
	/*
		取得参数分类节点Code
	 */
	function getCmsChannelId() {
		var node = $("#ulCmsChannelTree").tree("getSelected");
		if (node == null) {
			var parentId = "";
			return parentId;
		}
		return node.id;
	}
	function openAddDialog() {
		var cmsChannelId = getCmsChannelId();
		if(isPermitted(cmsChannelId)){
			// 设置新增模式
			setAddMode();
			if (managementContext.detailPageMode == "Dialog") {
				openDialog("divDetailDialog", '新增' + managementContext.title);
			} else if (managementContext.detailPageMode == "Page") {
				window.location.href = managementContext.detailPageName + "?mode=add"
						+ "&selectedCmsChannelId=" + cmsChannelId + "&r="
						+ Math.random();
			}
			event.stopPropagation();
		}
	}
	/*
	 * 输出树
	 */
	function outputTree(controlId, lstData, valueFieldName, textFieldName,
			parentFieldName, rootText, rootValue, checkbox, clickCallback) {
	
		var childrenTreeData = getTreeData(lstData, rootValue, valueFieldName,
				textFieldName, parentFieldName);
	
		var treeData = new Array();
		var rootNode = new Object();
		rootNode.id = rootValue;
		rootNode.text = rootText;
		rootNode.children = childrenTreeData;
		treeData.push(rootNode);
		var treeOptions = {
			checkbox : checkbox,
			data : treeData,
			onClick : function(node) {
				if (clickCallback != null) {
					clickCallback(node);
				}
			}
		};
		// alert(JSON.stringify(treeOptions));
		$("#" + controlId).tree(treeOptions);
		$("#_easyui_tree_2 .tree-hit").trigger("click");
	}
	/*
	 * 转移内容
	 */
	function transferDataItems() {
		var selectedRows = [];
		if (managementContext.gridType == "List") {
			selectedRows = $('#tableGrid').datagrid('getSelections');
	
		} else if (managementContext.gridType == "Tree") {
			selectedRows = $('#tableGrid').treegrid('getCheckedNodes');
		} else {
			return;
		}
		if (selectedRows.length == 0) {
			alert("请至少选择一行数据!");
			return false;
		}
		var primaryKeys = [];
		for ( var i = 0; i < selectedRows.length; i++) {
			if (managementContext.primaryKeyName == "id") {
				primaryKeys.push(selectedRows[i].id);
			} else if (managementContext.primaryKeyName == "code") {
				primaryKeys.push(selectedRows[i].code);
			}
		}
		// alert(primaryKeys);
		var data = new Object();
		openTransferDialog(primaryKeys)
	}
	/*
	 * 打开修改对话框
	 */
	function openTransferDialog(primaryKeys) {
	
		// 绑定实体
		//bindEntity(primaryKeys);
			window.location.href = "CmsContentTransferManagement.htm?"
					+ "primaryKeys=" + primaryKeys + "&r="
					+ Math.random();
		event.stopPropagation();
	
	}
	/*
	 * 移动数据
	 */
	function move(moveDirection, primaryKey, parentValue) {
		var data = new Object();
		data.moveDirection = moveDirection;
		data.tableName = "cms_content";
		data.id = primaryKey;
		data.condition = " cms_channel_id="+ parentValue;
		call("MoveCms", data, function(result) {
			refreshControls();
			bindData();
		});
		event.stopPropagation();
	}
</script>
</head>
<body>
	<div class="easyui-layout" style="width:100%;" fit="true">
		<div region="west" split="true" title="" style="width:250px;"
			id="divNbqaBusinessTypePanel">
			<p style="padding:5px;margin:0;"></p>
			<ul id="ulCmsChannelTree" class="easyui-tree">
			</ul>
		</div>
		<div id="content" region="center" style="padding:1px;">
			<div class="toolbar_panel" id="divToolbar">
				<a href="#" class="easyui-linkbutton" iconCls="icon-add"
					plain="true" onclick="openAddDialog()" id="btnAdd">新增</a> <a href="#"
					class="easyui-linkbutton" iconCls="icon-remove" plain="true"
					onclick="deleteDataItems()" id="btnBatchDelete">删除</a><a id="lnkRefreshPage" href="#"
					class="easyui-linkbutton" iconCls="icon-reload" plain="true"
					onclick="refreshPage()">刷新</a><a href="#"
				class="easyui-linkbutton" iconCls="icon-reload" plain="true"
				onclick="transferDataItems()" id="btnTransfer">转移</a>
			</div>
			<div id="divSearchPanel" class="search_panel easyui-panel">
				<div class="search_item">
					<span class="search_item_caption">名称:</span> <input
						id="txtSearchTitle" class="search_item_textbox easyui-textbox">
				</div>
				<div class="search_item">
					<span class="search_item_caption">作者:</span> <input
						id="txtSearchAuthor" class="search_item_textbox easyui-textbox">
				</div>
				<div class="search_item">
					<span class="search_item_caption">来源:</span> <input
						id="txtSearchSource" class="search_item_textbox easyui-textbox">
				</div>
				<div class="search_item_command">
					<a href="#" class="easyui-linkbutton" plain="true"
						iconCls="icon-search" onclick="query()">查询</a>
				</div>
			</div>
			<table id="tableGrid">
			</table>
	</div>
</body>
</html>