package BRP.service;

import BRP.data.MemberCard;
import BRP.data.MemberCardRenewLog;
import BRP.data.MemberCardServiceTimeLog;
import BRP.data.PayOrder;
import BRP.model.MemberCardManager;
import BRP.model.MemberCardRenewLogManager;
import BRP.model.MemberCardServiceTimeLogManager;
import BRP.model.PayOrderManager;
import net.sf.json.JSONObject;
import org.apache.ibatis.session.SqlSession;
import strosoft.app.common.MyBatisManager;
import strosoft.app.service.ServiceHandler;
import strosoft.app.util.JsonHelper;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.math.BigDecimal;
import java.sql.Timestamp;
import java.text.SimpleDateFormat;
import java.util.Date;

/*
 * 会员续费
 */
public class AddMemberCardRenewLogServiceHandler extends ServiceHandler {

    public void process(HttpServletRequest request, HttpServletResponse response)
            throws Exception {

        SqlSession sqlSession = null;
        try {
            sqlSession = MyBatisManager.getInstance().openSession();
            JSONObject jData = this.getRequestData(request);
            Integer companyId = JsonHelper.getInt(jData, "companyId"); // 门店id
            Integer memberId = JsonHelper.getInt(jData, "memberId"); // 会员id
            Integer memberCardId = JsonHelper.getInt(jData, "memberCardId"); // 会员卡id
            Integer activityId = JsonHelper.getInt(jData, "activityId"); // 活动id
            BigDecimal oldAmount = JsonHelper.getDecimal(jData, "oldAmount"); // 原续费价格
            BigDecimal amount = JsonHelper.getDecimal(jData, "amount"); // 续费价格
            BigDecimal newAmount = JsonHelper.getDecimal(jData, "newAmount"); // 新续费价格
            String paymentMethodCode = JsonHelper.getString(jData, "paymentMethodCode"); // 支付方式
            Integer employeeId = JsonHelper.getInt(jData, "employeeId"); // 办理人
            String remark = JsonHelper.getString(jData, "remark"); // 支付方式
            String expireDate = JsonHelper.getString(jData, "expireDate"); // 到期时间
            Integer buyDays = JsonHelper.getInt(jData, "buyDays"); // 购买天数
            Integer giftDays = JsonHelper.getInt(jData, "giftDays"); // 赠送天数
            Integer loanableNum = JsonHelper.getInt(jData, "loanableNum"); // 可借本书

            MemberCardRenewLog memberCardRenewLog = new MemberCardRenewLog();
            memberCardRenewLog.setMemberId(memberId);
            memberCardRenewLog.setMemberCardId(memberCardId);
            memberCardRenewLog.setActivityId(activityId);
            memberCardRenewLog.setOldAmount(oldAmount);
            memberCardRenewLog.setAmount(amount);
            memberCardRenewLog.setNewAmount(newAmount);
            memberCardRenewLog.setPaymentMethodCode(paymentMethodCode);
            memberCardRenewLog.setEmployeeId(employeeId);
            memberCardRenewLog.setRemark(remark);
            memberCardRenewLog.setCreateTime(new Timestamp(System.currentTimeMillis()));
            MemberCardRenewLogManager.getInstance().add(sqlSession,memberCardRenewLog);

            MemberCard memberCard = MemberCardManager.getInstance().getEntity(memberCardId);
            memberCard.setMembershipAmount(newAmount);
            memberCard.setMaxBorrowableQuantity(loanableNum);
            memberCard.setExpireDate(Timestamp.valueOf(expireDate));
            MemberCardManager.getInstance().update(sqlSession, memberCard);
            //添加pay_order账单
            PayOrder newPayOrder = new PayOrder();
            newPayOrder.setCompanyId(companyId);
            newPayOrder.setAmount(amount);
            SimpleDateFormat sdf = new SimpleDateFormat("yyyyMMddHHmmss");
            newPayOrder.setMemberId(memberId);
            Date now = new Date();
            String payOrderNo = sdf.format(now);
            newPayOrder.setPayOrderNo(payOrderNo);
            Timestamp currentTimestamp = new Timestamp(System.currentTimeMillis());
            newPayOrder.setBusinessDate(currentTimestamp);
            newPayOrder.setPaymentItemCode("MembershipFee");
            newPayOrder.setPayTime(currentTimestamp);
            newPayOrder.setOperatorId(employeeId);
            newPayOrder.setPaymentMethodCode(paymentMethodCode);
            newPayOrder.setIsFinished(true);
            newPayOrder.setIsPaid(true);
            PayOrderManager.getInstance().add(sqlSession, newPayOrder);

            // 会员卡变更记录
            MemberCardServiceTimeLog memberCardServiceTimeLog = new MemberCardServiceTimeLog();
            memberCardServiceTimeLog.setMemberId(memberId);
            memberCardServiceTimeLog.setEffectiveTime(memberCard.getEffectiveDate());
            memberCardServiceTimeLog.setExpiryTime(memberCard.getExpireDate());
            memberCardServiceTimeLog.setMemberCardServiceTimeTypeCode("MemberRenew");
            memberCardServiceTimeLog.setDays(buyDays);
            memberCardServiceTimeLog.setCost(new BigDecimal(giftDays));
            memberCardServiceTimeLog.setRemark(remark);
            memberCardServiceTimeLog.setCreateTime(new Timestamp(System.currentTimeMillis()));
            MemberCardServiceTimeLogManager.getInstance().add(sqlSession,memberCardServiceTimeLog);
            sqlSession.commit();
            this.writeSuccessResponse(response);
        } catch (Exception e) {
            sqlSession.rollback();
            e.printStackTrace();
        } finally {
            sqlSession.close();
        }
    }
}