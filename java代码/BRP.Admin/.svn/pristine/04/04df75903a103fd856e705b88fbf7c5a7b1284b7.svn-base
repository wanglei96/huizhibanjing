<!DOCTYPE html>
<html>
<head>
<title>栏目管理的编辑界面</title>
<meta charset="utf-8">
<link rel="stylesheet" type="text/css"
	href="../../themes/custom/easyui.css" />
<link rel="stylesheet" type="text/css" href="../../themes/icon.css" />
<script type="text/javascript" src="../../js/jquery.js"></script>
<script type="text/javascript" src="../../js/common.js"></script>
<script type="text/javascript" src="../../js/config.js"></script>
<script type="text/javascript" src="../../js/json2.js"></script>
<script type="text/javascript" src="../../js/jquery.easyui.min.js"></script>
<script type="text/javascript" src="../../js/util.js?v=1"></script>
<script type="text/javascript" src="../../js/easyui-lang-zh_CN.js"></script>
<script type="text/javascript" src="../../js/jquery.cookie.js"></script>
<script type="text/javascript" src="../../js/jquery.query.js"></script>
<script type="text/javascript" src="../../js/jquery.uploader.js"></script>
<link rel="stylesheet" href="../../css/common.css?v=2" type="text/css"></link>
<link rel="stylesheet" href="../../css/base.css" type="text/css"></link>
<script type="text/javascript" src="../../js/cms/cms.promission.js"></script>
<link rel="stylesheet" href="../../css/CmsChannelDetial.css"
	type="text/css"></link>
<script type="text/javascript" src="../../js/detail.js"></script>
<!-- 配置文件 -->
<script type="text/javascript" src="../../js/ueditor/ueditor.config.js"></script>
<!-- 编辑器源码文件 -->
<script type="text/javascript" src="../../js/ueditor/ueditor.all.js"></script>
<script type="text/javascript">
	detailContext.dataName = "CmsChannel";
	detailContext.tableName = "cms_channel";
	var ue;
	var createTime;
	var channelDetial;
	var dataInfo = null;
	
	/*
	绑定控件
	 */
	function bindControls() {
		if (isAddMode()) {
			bindIdNameComboBox("cmbCmsChannelTemplateId", "cms_template",
					"cms_template_type_code='Channel' and cms_site_id="
							+ getCookie("cmsSiteId"));
			bindIdNameComboBox("cmbCmsContentTemplateId", "cms_template",
					"cms_template_type_code='Content' and cms_site_id="
							+ getCookie("cmsSiteId"));
			bindCodeNameComboBox("cmbCmsLinkTypeCode", "cms_link_type");//链接类型:"
			//上级栏目
			bindCmsComboTreeWidthPermission("ctParentId", "GetCmsChannelList", 0, "id", "name", "parentId",null,"cms_site_id="+$.cookie("cmsSiteId"));
			//动态加载栏目组
			bindCmsChannelGroup();
			//实例化编辑器
			ue=new UE.ui.Editor();
			ue.render('txtContainer');
		}
	}
	
	/*
	 动态加载栏目组
	 */

	function bindCmsChannelGroup(successFunction) {
		var data = new Object();
		var cmsSiteId = $.cookie("cmsSiteId");
		data.tableName = "cms_channel_group";
		data.condition = "cms_site_id='" + cmsSiteId + "'";
		data.async = false;
		call("GetTable",data,function(result) {
			$.each(result.data,function(index, value) {
					$("#divCmsChannelGroup").append("<input id='chk"+value.code+"' class='isCmsChannelGroupCode' type='checkbox' name='tj' value='"+value.code+"'>"
														+ value.name
														+ "");
									});
					if (typeof(successFunction) != "undefined"){
						successFunction();
					}
				}
		);
				
	}
	
/*
 * 绑定数据实体
 */
function bindEntity(primaryKey) {
	var data = new Object();
	data.id = primaryKey;
	data.cmsSiteId =  $.cookie("cmsSiteId");
	call("GetViewCmsChannelInfoChannelIdCustom",data,function(result){
		dataInfo = result.data;
		//根据语言编码展示信息
		outputEntityByCmsLanguageCode();
	})
}

//根据语言编码展示信息
function outputEntityByCmsLanguageCode(){
	var viewCmsChannelLanguage = dataInfo.dataList[currentCmsLanguageCode];
	outputEntity(viewCmsChannelLanguage);
}
	/*
	 * 绑定栏目组数据
	 */
	function bindCmsChannelGroupData(primaryKey) {
		var data = new Object();
		data.tableName = "cms_channel_channel_group";
		data.condition = "cms_channel_id='" + primaryKey + "'";
		data.async = false;
		call("GetTable", data, function(result) {
			$.each(result.data, function(index, value) {
				var checkBoxValue = value.cms_channel_group_code;
				$("#chk" + checkBoxValue).prop("checked",
						true);
			});
			if (isViewMode()) {
					$(".isCmsChannelGroupCode").attr("disabled", "disabled"); 
				}
		});
	}
	/*
	 * 输出实体信息
	 */
	function outputEntity(dataItem) {
		//alert(JSON.stringify(dataItem));
		var primaryKey = $.query.get(detailContext.primaryKeyName);
		channelDetial = dataItem;
		outputEntityBase(dataItem);
		//动态加载栏目组
		//bindCmsChannelGroup();
		//上级栏目
		var cmsChannelCondition = "cms_site_id=" + getCookie("cmsSiteId")+" and id !="+primaryKey;
		bindCmsComboTreeWithValueAndPermissionAsParentNode("ctParentId", "GetCmsChannelList", 0,"id", "name", "parentId",false,cmsChannelCondition,
				dataItem.parentId,$.query.get(detailContext.primaryKeyName));
		//栏目模板
		bindIdNameComboBoxWithValue("cmbCmsChannelTemplateId", "cms_template",
				" cms_site_id="
						+ getCookie("cmsSiteId"), dataItem.cmsChannelTemplateId);
		//内容模板
		bindIdNameComboBoxWithValue("cmbCmsContentTemplateId", "cms_template",
				"cms_template_type_code='Content' and cms_site_id="
						+ getCookie("cmsSiteId"), dataItem.cmsContentTemplateId);
		//链接类型
		bindCodeNameComboBoxWithValue("cmbCmsLinkTypeCode", "cms_link_type","", dataItem.cmsLinkTypeCode);
		//绑定所属栏目组信息
		bindCmsChannelGroup(function(){
			bindCmsChannelGroupData(primaryKey);
		})
		//绑定图片地址
		bindImageFileId(dataItem);
		//模板内容
		if (isViewMode()) {
			ue=new UE.ui.Editor({readonly:true,});
			ue.render('txtContainer');
			//隐藏选择图片按钮divCmsChannelTemplateId
			$("#imgUploadFileUpload").hide();
		}else{
			//修改时隐藏上级栏目
			$("#divParentIdTree").hide();
			$("#divCmsChannelTemplateId").hide();
			$("#divCmsContentTemplateId").hide();
			var ue=new UE.ui.Editor();
			ue.render('txtContainer');
			createTime = dataItem.createTime;
		}
		ue.ready(function() {
			ue.setContent(dataItem.text);
			
		});
		
	}
	/*
	 * 绑定图片地址
	 */
	function bindImageFileId(dataItem){
		if(dataItem.imageFileId != ""){
			var data = new Object();
			data.tableName = "sys_upload_file";
			data.condition = "id=" + dataItem.imageFileId + "";
			call("GetTable", data, function(result) {
				$.each(result.data, function(index, value) {
					$("#imageFilePath").val(value.path);
					$("#imageAutoUpload").attr("src",config.adminRootUrl+value.path);
				});
				if (isViewMode()) {
						$("#imageFilePath").attr("disabled", "disabled"); 
						//$(".inputFilePath").css("margin-top","16px");
						//$(".photo").hide();
				}
			});	
		}
		
	}
	/*
	 * 取得实体
	 */
	function getEntity() {
		var newEntity = getEntityBase();
		var text = UE.getEditor('txtContainer').getContent();
		var groupCodes = new Array();
		$("#divCmsChannelGroup :checked").each(function() {
			groupCodes.push($(this).val());//向数组中添加元素  
		});
		var cmsSiteId = $.cookie("cmsSiteId");
		var operatorId = $.cookie("sysUserId");
		newEntity.operatorId = operatorId;
		newEntity.text = text;
		newEntity.createTime = createTime;
		newEntity.cmsChannelGroupCodes = groupCodes;
		newEntity.cmsSiteId = cmsSiteId;
		return newEntity;
	}
	/*
	 * 保存
	 */
	function save() {
		var data = getEntity();
		data.cmsLanguageCode = currentCmsLanguageCode;
		if(data.parentId != 0 && !isPermitted(data.parentId) && isParentIdChange(data.parentId)){
			alert("所选上级栏目没有权限");
		}else{
			if (isEditMode()) {
			//设置多语言栏目ID
			data.cmsChannelLanguageId = dataInfo.dataList[currentCmsLanguageCode].cmsChannelLanguageId;
			call(detailContext.updateServiceName, data, function(result) {
				closeDetailDialog();
				//bindData();
			});
			} else {
				call(detailContext.addServiceName, data, function(result) {
					closeDetailDialog();
					//bindData();
				});
			}
		}

	}
	//判断parentId是否修改
	function isParentIdChange(parentId){
		if(typeof(dataItem)=="undefined"){
			return true;
		}
		if(null == parentId || parentId == 0){
			return true;
		}else{
			return (channelDetial.parentId != parentId);
		}
	}
	
</script>

</head>

<body>
	<div id="editContent" class="easyui-layout"
		style="width:100%;overflow:auto;" fit="true">
		<div buttons="#dlg-buttons">
			<form id="formDetail" method="post" enctype="multipart/form-data"
				class="detail_form">
				<div class="form_item" style="display:none">
					<input id="txtDisplayOrder" name="displayOrder"
						class="easyui-textbox" label="显示顺序:" labelPosition="left"
						style="width:400px;height: 100%;">
				</div>
				<div class="form_item" style="margin-bottom: 3px;">
					<input id="txtName" name="name" class="easyui-textbox"
						label="栏目名称:" labelPosition="left"
						style="width:400px;height: 100%;"> <span class="copy_item"
						id="copy_item_name" title="栏目名称"> <a href="#"
						class="easyui-linkbutton" iconCls="icon-search" plain="true"></a>
					</span>
				</div>
				<div class="form_item" style="margin-bottom: 3px;">
					<input id="txtCode" name="code" class="easyui-textbox"
						label="栏目编码:" labelPosition="left"
						style="width:400px;height: 100%;">
				</div>
				<div class="form_item" style="margin-bottom: 3px;">
					<input id="txtTitle" name="title" class="easyui-textbox"
						label="页面title:" labelPosition="left"
						style="width:400px;height: 100%;"> <span class="copy_item"
						id="copy_item_title" title="页面title"> <a href="#"
						class="easyui-linkbutton" iconCls="icon-search" plain="true"></a>
					</span>
				</div>
				<div class="form_item" id="divParentIdTree"
					style="margin-bottom: 3px;">
					<input id="ctParentId" class="easyui-combotree" label="上级栏目:"
						labelPosition="left" style="width:400px;height: 100%;">
				</div>
				<div class="form_item" style="margin-bottom: 3px;">
					<input id="txtUrl" class="easyui-textbox" label="栏目链接:"
						labelPosition="left" style="width:400px;height: 100%;">
					<!-- <span class="copy_item"
						id="copy_item_Url" title="栏目链接"> <a href="#"
						class="easyui-linkbutton" iconCls="icon-search" plain="true"></a>
					</span> -->
				</div>
				<div class="form_item" style="margin-bottom: 3px; display: none">
					<input id="cmbCmsLinkTypeCode" class="easyui-combobox"
						label="链接类型:" labelPosition="left"
						style="width:400px;height: 100%;">
				</div>
				<div class="form_item" style="margin-bottom: 3px; display: none">
					<input id="cmbCmsContentTypeCode" class="easyui-combobox"
						label="内容类型:" labelPosition="left"
						style="width:400px;height: 100%;">
				</div>
				<div class="form_item" id="divCmsChannelTemplateId"
					style="margin-bottom: 3px;">
					<input id="cmbCmsChannelTemplateId" class="easyui-combobox"
						label="栏目模板:" labelPosition="left"
						style="width:400px;height: 100%;">
				</div>
				<div class="form_item" id="divCmsContentTemplateId"
					style="margin-bottom: 3px;">
					<input id="cmbCmsContentTemplateId" class="easyui-combobox"
						label="本栏目内容模板:" labelPosition="left"
						style="width:400px;height: 100%;">
				</div>
				<div class="form_item" style="margin-bottom: 3px;">
					<input id="txtChannelFilePathRule" class="easyui-textbox"
						label="页面生成地址:" labelPosition="left"
						style="width:400px;height: 100%;"> <span class="copy_item"
						id="copy_item_channelFilePathRule" title="页面生成地址"> <a
						href="#" class="easyui-linkbutton" iconCls="icon-search"
						plain="true"></a> </span>
				</div>
				<div class="form_item" style="margin-bottom: 3px; display: none">
					<input id="txtContentFilePathRule" class="easyui-textbox"
						label="内容页面命名规则:" labelPosition="left"
						style="width:400px;height: 100%;">
				</div>
				<div class="form_item_full" style="height:50px;">
					<span style="float:left;width:148px;line-height:50px;">图片:</span> <input
						type="hidden" class="easyui-textbox" id="hfImageFileId" /> <input
						class="inputFilePath" id="imageFilePath" /> <input type="file"
						id="imageAutoUploadFileUpload" style="display: none" /> <img
						src="../../img/uploadPic.png" class="photo" id="imageAutoUpload" />
				</div>
				<div id="divProgressBar" style="display: none;">
					<img src="../../img/progressbar.jpg"
						style="width:300px;height:30px;" />
				</div>
				<div style="margin-bottom:10px">
					<div style="float:left;line-height:250px;">
						<span>内容:</span>
					</div>
					<div
						style="margin-bottom:10px;margin-left:105px;float: left;position: relative;"
						class="copy_item_container">
						<script id="txtContainer" name="content" type="text/plain"
							style="width:1400px;height:500px;">
    					</script>
						<span class="copy_item" id="copy_item_text" title="内容"
							style="float: right;position: absolute;top: 21px;right:-23px;">
							<a href="#" class="easyui-linkbutton" iconCls="icon-search"
							plain="true"></a> </span>
					</div>
				</div>

				<div class="form_item_full" style="margin-bottom:10px;">
					<input id="txtKeyword" class="easyui-textbox" label="关键字:"
						multiline="true" labelPosition="left"
						style="width:1000px;height:120px;"> <span
						class="copy_item" id="copy_item_keyword" title="关键字"> <a
						href="#" class="easyui-linkbutton" iconCls="icon-search"
						plain="true"></a> </span><span>关键字之间用“,”隔开</span>
				</div>

				<div class="form_item_full" style="margin-bottom:10px;">
					<input id="txtDescription" class="easyui-textbox" label="描述:"
						multiline="true" labelPosition="left"
						style="width:1000px;height:120px;"> <span
						class="copy_item" id="copy_item_description" title="描述"> <a
						href="#" class="easyui-linkbutton" iconCls="icon-search"
						plain="true"></a> </span>
				</div>

				<div style="margin-bottom:10px;float: left;width: 90%;">
					<div style="float:left;width:83px">
						<span>栏目组:</span>
					</div>
					<div id="divCmsChannelGroup"></div>
				</div>
			</form>
		</div>
		<div id="divDetailCommandBar" class="detail_commandbar"
			style="text-align: center;float: left;width: 90%;height: 40px;">
			<a href="javascript:void(0)" class="easyui-linkbutton"
				iconCls="icon-ok" onclick="save()" style="width:90px" id="btnSave">保存</a>
			<a href="javascript:void(0)" class="easyui-linkbutton"
				iconCls="icon-cancel" onclick="javascript:closeDetailDialog();"
				style="width:90px">返回</a>
		</div>
		<div class="copyItemDiv" id="copyItemDiv"></div>
	</div>
	<!-- 上传图片 -->
	<script>
		$(function() {
			$("#imageAutoUpload").uploadify({
				isImage : true,
				fileUploadID : "imgAutoUploadFileUpload",
				uploading : function() {
					showProgressBar();
				},
				success : function(result) {
					hideProgressBar();
					//alert(JSON.stringify(result));
					$("#hfImageFileId").val(result.data.id);
					$("#imageFilePath").val(result.data.path);
				},
				fail : function(result) {
					hideProgressBar();
				}
			});
		});
		function showProgressBar() {
			$("#divProgressBar").show();
		}
		function hideProgressBar() {
			$("#divProgressBar").hide();
		}
	</script>
</body>
</html>